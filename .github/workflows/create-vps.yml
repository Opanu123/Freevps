name: Create VPS with Minecraft + Dropbox Backup + Discord Notify

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # every 6 hours

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt update && sudo apt install -y tmate openjdk-17-jre-headless wget zip python3 python3-pip

      - name: Start tmate session and save SSH
        run: |
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' > links/ssh.txt

      - name: Send SSH to Discord (fixed JSON escape)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          ssh_url=$(cat links/ssh.txt | tr -d '\n' | sed 's/"/\\"/g')
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"ðŸŸ¢ VPS Ready! SSH: $ssh_url\"}" \
            "$DISCORD_WEBHOOK_URL"

      - name: Download Paper Minecraft 1.20.1
        run: |
          mkdir -p minecraft
          wget https://api.papermc.io/v2/projects/paper/versions/1.20.1/builds/196/downloads/paper-1.20.1-196.jar -O minecraft/server.jar

      - name: Accept EULA
        run: echo "eula=true" > minecraft/eula.txt

      - name: Start server once to generate files
        run: |
          cd minecraft
          java -Xmx2G -Xms1G -jar server.jar nogui || true

      - name: Download plugins (EssentialsX & Geyser)
        run: |
          mkdir -p minecraft/plugins
          wget https://github.com/EssentialsX/Essentials/releases/latest/download/EssentialsX.jar -O minecraft/plugins/EssentialsX.jar
          wget https://download.geysermc.org/v2/projects/geyser/versions/latest/builds/latest/downloads/standalone -O minecraft/plugins/Geyser.jar

      - name: Configure server.properties
        run: |
          echo "enable-command-block=true" >> minecraft/server.properties
          echo "motd=A Free GitHub VPS Minecraft Server" >> minecraft/server.properties

      - name: Start Minecraft server (background for 5 min)
        run: |
          cd minecraft
          java -Xmx2G -Xms1G -jar server.jar nogui &
          sleep 300

      - name: Zip Minecraft world for backup
        run: |
          cd minecraft
          zip -r ../world_backup.zip world

      - name: Upload backup to Dropbox
        run: |
          python3 dropbox_helper.py upload world_backup.zip /backups/world_backup_$(date +"%Y-%m-%d_%H-%M").zip
        env:
          DROPBOX_TOKEN: ${{ secrets.DROPBOX_TOKEN }}

      - name: Commit SSH + backup info to repo
        run: |
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions Bot"
          git add links/ssh.txt world_backup.zip
          git commit -m "Auto backup & SSH update $(date -u)" || echo "No changes to commit"
          git push

      - name: Keep VPS alive for 6 hours
        run: sleep 21600
