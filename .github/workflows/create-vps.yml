name: Create VPS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # Runs every 6 hours (UTC)

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ⬇️ Checkout code
        uses: actions/checkout@v3

      - name: 🔧 Install dependencies
        run: |
          sudo apt update
          sudo apt install -y tmate curl unzip zip git

      - name: 📁 Create dirs
        run: mkdir -p links .backup plugins

      - name: 🔐 Start tmate SSH
        run: |
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          SSH_CMD=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          echo "🔐 SSH: $SSH_CMD"
          echo "$SSH_CMD" > links/vps_ssh.txt
          echo "SSH=$SSH_CMD" >> $GITHUB_ENV

      - name: 📦 Download last backup from Dropbox
        run: |
          curl -L https://www.dropbox.com/download?dl=packages/dropbox.py -o dropbox.py
          python3 dropbox.py download /vps_backup.zip vps_backup.zip || echo "⚠️ No backup found."
          unzip -o vps_backup.zip || echo "Nothing to unzip."

      - name: 📁 Upload plugins from Dropbox
        run: |
          mkdir -p plugins
          python3 dropbox.py download /plugins.zip plugins.zip || echo "⚠️ No plugins found."
          unzip -o plugins.zip -d plugins || echo "Nothing to unzip."

      - name: 💾 Zip backup
        run: |
          zip -r vps_backup.zip . -x ".git/*" ".github/*" "vps_backup.zip" || echo "Nothing to zip."

      - name: ☁️ Upload backup to Dropbox
        run: |
          python3 dropbox.py upload vps_backup.zip /vps_backup.zip
          echo "✅ Backup uploaded to Dropbox"

      - name: 📤 Push SSH info + backup
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "🔁 VPS auto backup + SSH update"
          file_pattern: 'links/vps_ssh.txt'

      - name: 🔔 Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"✅ VPS Started!\nSSH: $SSH\"}" \
            $DISCORD_WEBHOOK

      - name: ⏳ Keep alive for 6 hours
        run: |
          echo "⏳ VPS will stay active for 6 hours..."
          sleep 21600
