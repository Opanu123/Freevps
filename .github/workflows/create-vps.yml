name: Create VPS with Minecraft, Dropbox Backup & Discord Notify

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Create required directories
        run: |
          mkdir -p links minecraft plugins

      - name: Install dependencies & tmate
        run: |
          sudo apt update
          sudo apt install -y openjdk-17-jre-headless wget unzip tmate python3 python3-pip
          pip3 install dropbox

      - name: Start tmate session and save SSH command
        run: |
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' > links/ssh.txt
          echo "âœ… SSH info saved."

      - name: Send SSH info to Discord
        run: |
          ssh_url=$(cat links/ssh.txt)
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"ðŸŸ¢ Your VPS is ready! SSH: $ssh_url\"}" \
            "$DISCORD_WEBHOOK_URL"

      - name: Download PaperMC 1.20.1 server jar
        run: |
          wget -q https://api.papermc.io/v2/projects/paper/versions/1.20.1/builds/196/downloads/paper-1.20.1-196.jar -O minecraft/server.jar

      - name: Accept Minecraft EULA
        run: echo "eula=true" > minecraft/eula.txt

      - name: Run server once to generate files
        run: |
          cd minecraft
          java -Xmx2G -Xms1G -jar server.jar nogui || true

      - name: Download plugins EssentialsX and Geyser
        run: |
          wget -q https://github.com/EssentialsX/Essentials/releases/latest/download/EssentialsX.jar -P minecraft/plugins
          wget -q https://download.geysermc.org/v2/projects/geyser/versions/latest/builds/latest/downloads/standalone -O minecraft/plugins/Geyser.jar

      - name: Configure server.properties
        run: |
          echo "enable-command-block=true" >> minecraft/server.properties
          echo "motd=A Free GitHub Minecraft Server" >> minecraft/server.properties

      - name: Start Minecraft server (background)
        run: |
          cd minecraft
          java -Xmx2G -Xms1G -jar server.jar nogui &

      - name: Wait 5 minutes for server startup
        run: sleep 300

      - name: Backup Minecraft world to zip
        run: |
          cd minecraft
          zip -r ../world_backup.zip world

      - name: Upload backup to Dropbox
        run: |
          python3 dropbox_helper.py upload world_backup.zip /backups/world_backup_$(date +"%Y-%m-%d_%H-%M").zip

      - name: Notify Discord backup done
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"âœ… Minecraft world backed up and uploaded to Dropbox\"}" \
            "$DISCORD_WEBHOOK_URL"

      - name: Keep VPS alive for 6 hours
        run: sleep 21600
